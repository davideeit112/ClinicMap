<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script> -->

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <style>
        .errMsg {
            color: red;
            text-align: left;
        }

        .need2edit {
            background-color: yellow;
        }
    </style>
</head>

<body>
    <h1>註冊頁</h1>
    <a href="loginMember.html">回登入頁(測試用)</a>
    <form>
        <!-- <form action="memberRegisterPage" method="post"> -->
        註冊身份:
        <label><input type="radio" name="loginLevel" id="member" value="member" checked />會員</label>
        <label><input type="radio" name="loginLevel" id="clinic" value="clinic" />診所</label>
        <table id="registerInfo"></table>
        
    </form>
    <button id="register">註冊</button>

    <button onclick="TestDemo1()">Demo1</button><br />


    <script>
        var checkAccount, checkName, checkPwd, checkPwdAgain, checkBirth, checkAddress,
            checkHeight, checkWeight, checkPhone, checkIdNum, checkGender = true, checkEmail;

        $("#register").click(function () {
            if($("input[name=loginLevel]:checked").val()=="member"){
                if (checkAccount && checkName && checkPwd && checkPwdAgain && checkBirth
                && checkAddress && checkHeight && checkWeight && checkPhone && checkIdNum && checkGender && checkEmail) {
                    $.ajax({
                        url:"memberRegisterPage",
                        type:"post",
                        data:$("form").serializeArray(),
                        success:function(data){
                            alert("註冊成功，已送驗證信到您的信箱");
                            window.location.href = "loginMember.html";
                        }
                    });
                } else {
                    alert("資料有誤");
                    
                    if(!checkAccount){
                        $("#memberAccount").addClass("need2edit");
                        ($("#memberAccount").val()=="")?$("#accountErrMsg").html("此欄位不能空白"):$("#accountErrMsg").html("需要修改"); 
                    }
                    
                    if(!checkName){
                        $("#memberName").addClass("need2edit");
                        ($("#memberName").val()=="")?$("#nameErrMsg").html("此欄位不能空白"):$("#nameErrMsg").html("需要修改");
                    }
                    
                    if(!checkPwd){
                        $("#memberPwd").addClass("need2edit");
                        ($("#memberPwd").val()=="")?$("#pwdErrMsg").html("此欄位不能空白"):$("#pwdErrMsg").html("需要修改");
                    }

                    if(!checkPwdAgain){
                        $("#memberPwdCheck").addClass("need2edit");
                        ($("#memberPwdCheck").val()=="")?$("#pwdCheckErrMsg").html("此欄位不能空白"):$("#pwdCheckErrMsg").html("需要修改"); 
                    }

                    if(!checkBirth){
                        $("#memberBirth").addClass("need2edit");
                        ($("#memberBirth").val()=="")?$("#birthErrMsg").html("此欄位不能空白"):$("#birthErrMsg").html("需要修改"); 
                    }

                    if(!checkAddress){
                        $("#memberAddress").addClass("need2edit");
                        ($("#memberAddress").val()=="")?$("#addressErrMsg").html("此欄位不能空白"):$("#addressErrMsg").html("需要修改");
                    }

                    if(!checkHeight){
                        $("#memberHeight").addClass("need2edit");
                        ($("#memberHeight").val()=="")?$("#heightErrMsg").html("此欄位不能空白"):$("#heightErrMsg").html("需要修改");  
                    }

                    if(!checkWeight){
                        $("#memberWeight").addClass("need2edit");
                        ($("#memberWeight").val()=="")?$("#weightErrMsg").html("此欄位不能空白"):$("#weightErrMsg").html("需要修改");
                    }

                    if(!checkPhone){
                        $("#memberPhone").addClass("need2edit");
                        ($("#memberPhone").val()=="")?$("#phoneErrMsg").html("此欄位不能空白"):$("#phoneErrMsg").html("需要修改"); 
                    }

                    if(!checkIdNum){
                        $("#memberIdNumber").addClass("need2edit");
                        ($("#memberIdNumber").val()=="")?$("#IdNumErrMsg").html("此欄位不能空白"):$("#IdNumErrMsg").html("需要修改");  
                    }

                    if(!checkEmail){
                        $("#email").addClass("need2edit");
                        ($("#email").val()=="")?$("#emailErrMsg").html("此欄位不能空白"):$("#emailErrMsg").html("需要修改");
                    }
                }
            }else {
                if(checkAccount && checkEmail){
                    $.ajax({
                        url:"clinicRegisterPage",
                        type:"post",
                        data:{
                            "clinicAccount":$("#clinicAccount").val(),
                            "clinicEmail":$("#email").val()
                        },
                        success:function(data){
                            alert("已完成註冊，請等候email通知");
                        }
                    });
                }else {
                    alert("資料有誤");
                    if(!checkAccount){
                        if($("#memberAccount").val()==""){ $("#accountErrMsg").html("此欄位不能空白"); }
                        else { $("#memberAccount").addClass("need2edit"); $("#accountErrMsg").html("需要修改"); }   
                    }
                    if(!checkEmail){
                        if($("#email").val()==""){ $("#emailErrMsg").html("此欄位不能空白"); }
                        else { $("#email").addClass("need2edit"); $("#emailErrMsg").html("需要修改"); }   
                    }
                }
            }
        });

        function TestDemo1() {
            $("#email").val("johnnyproject.test2@gmail.com");
            $("#memberPwd").val("123456@W");
            $("#memberPwdCheck").val("123456@W");
            $("#memberBirth").val("2020/04/22");
            $("#memberAddress").val("台北市資策會");
            $("#memberHeight").val("180");
            $("#memberWeight").val("80");
            $("#memberPhone").val("0911234678");
            $("#memberName").val("wu");
            // checkAccount = true, checkName = true, checkPwd = true, checkPwdAgain = true, checkBirth = true, checkAddress = true,
            // checkHeight = true, checkWeight = true, checkPhone = true, checkIdNum = true, checkGender = true, checkEmail = true;

            // $("#accountErrMsg").html("<img src='correct.png'>"); //因為unique，要自己輸入
            $("#nameErrMsg").html("<img src='correct.png'>");
            $("#pwdErrMsg").html("<img src='correct.png'>");
            $("#pwdCheckErrMsg").html("<img src='correct.png'>");
            $("#birthErrMsg").html("<img src='correct.png'>");
            $("#addressErrMsg").html("<img src='correct.png'>");
            $("#heightErrMsg").html("<img src='correct.png'>");
            $("#weightErrMsg").html("<img src='correct.png'>");
            $("#phoneErrMsg").html("<img src='correct.png'>");
            // $("#IdNumErrMsg").html("<img src='correct.png'>"); //因為unique，要自己輸入
            // $("#genderErrMsg").html("<img src='correct.png'>");
            $("#emailErrMsg").html("<img src='correct.png'>");

        }
        //-------------------------------------
        //初始化的註冊表格，預設是 "會員"
        // var txt = "<tr><td>會員照片：</td><td><input type='text' name='memberPhoto' id='memberPhoto'></td><td class='errMsg' id='photoErrMsg'></td></tr>"
        var txt = "<tr><td>會員帳號：</td><td><input type='text' name='memberAccount' id='memberAccount'></td><td class='errMsg' id='accountErrMsg'></td></tr>"
            + "<tr><td>會員姓名：</td><td><input type='text' name='memberName' id='memberName'></td><td class='errMsg' id='nameErrMsg'></td></tr>"
            + "<tr><td>會員密碼：</td><td><input type='password' name='memberPwd' id='memberPwd'></td><td class='errMsg' id='pwdErrMsg'></td></tr>"
            //密碼格式的提示
            + "<tr><td></td><td colspan='2'><font style='color:gray; font-size:13px'>至少6個字且必須包含英文字母、數字、特殊字元[!@#$%^&*]</font></td></tr>"
            + "<tr><td>確認密碼：</td><td><input type='password' name='memberPwdCheck' id='memberPwdCheck'></td><td class='errMsg' id='pwdCheckErrMsg'></td></tr>"
            + "<tr><td>會員生日：</td><td><input type='text' name='memberBirth' id='memberBirth'></td><td class='errMsg' id='birthErrMsg'></td></tr>"
            + "<tr><td>會員住址：</td><td><input type='text' name='memberAddress' id='memberAddress'></td><td class='errMsg' id='addressErrMsg'></td></tr>"
            + "<tr><td>會員身高(cm)：</td><td><input type='text' name='memberHeight' id='memberHeight' maxlength='3' placeholder='請輸入整數'></td><td class='errMsg' id='heightErrMsg'></td></tr>"
            + "<tr><td>會員體重(kg)：</td><td><input type='text' name='memberWeight' id='memberWeight' maxlength='3' placeholder='請輸入整數'></td><td class='errMsg' id='weightErrMsg'></td></tr>"
            + "<tr><td>會員電話：</td><td><input type='text' name='memberPhone' id='memberPhone' maxlength='10' placeholder='格式：09xxxxxxxx'></td><td class='errMsg' id='phoneErrMsg'></td></tr>"
            + "<tr><td>會員身分證字號：</td><td><input type='text' name='memberIdNumber' id='memberIdNumber' maxlength='10' placeholder='ex：A123456789'></td><td class='errMsg' id='IdNumErrMsg'></td></tr>"
            + "<tr><td>性別：</td><td><label><input type='radio' name='memberGender' value='male' checked/>男</label><label><input type='radio' name='memberGender' value='female'/>女</label></td><td class='errMsg' id='genderErrMsg'></td></tr>"
            + "<tr><td>電子信箱：</td><td><input type='email' name='memberEmail' id='email'></td><td id='emailErrMsg' class='errMsg'></td></tr>";
        $("#registerInfo").html(txt);
        checkFormat();

        //切換身份，切換註冊表格
        $("input[name=loginLevel]").change(function () {
            let loginLevel = $("input[name=loginLevel]:checked").val();
            if (loginLevel == "member") {
                $("#registerInfo").html(txt);
                $("#memberBirth").datepicker({
                    changeMonth: true,
                    changeYear: true,
                    yearRange: "1920:2020",
                    dateFormat: "yy/mm/dd"
                });
                checkFormat();
            } else {
                let txtC = "<tr><td>診所機構代碼：</td><td><input type='text' name='clinicAccount' id='clinicAccount'></td><td id='accountErrMsg' class='errMsg'></td></tr>"
                    + "<tr><td>診所電子信箱：</td><td><input type='email' name='clinicEmail' id='email'></td><td id='emailErrMsg' class='errMsg'></td></tr>";
                $("#registerInfo").html(txtC);

                //檢查診所機構代碼是否存在
                $("#clinicAccount").blur(function () {
                    $.ajax({
                        url: "isAccountExist",
                        type: "post",
                        data: {
                            "loginLevel": "clinic",
                            "account": $("#clinicAccount").val()
                        },
                        success: function (repeat) {
                            $("#accountErrMsg").html(eval(repeat) ? "<img src='correct.png'>" : "無此機構代碼");
                            if (eval(repeat)) { checkAccount = true; } else { checkAccount = false; }
                        }
                    });
                });
            
                //檢查email格式??? 還是用 input="email" ???
                $("#email").blur(function () {
                let patternParam = '^[a-zA-Z0-9]+[\.]*[a-zA-Z0-9]+@[a-z]+\.[a-z\.]+';
                let pattern = new RegExp(patternParam);
                checkEmail = false;
                let msg = "";

                if ($("#email").val() != "") {
                    if (!pattern.test($("#email").val())) {
                        msg = "Error";
                    } else {
                        checkEmail = true;
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#emailErrMsg").html(msg);
            });

            }
        });

        function checkFormat() {
            //會員帳號
            $("#memberAccount").blur(function () {
                let patternParam = '[a-zA-Z]+[a-zA-Z0-9]*'; //只能英文的驗證，不能"空白"、"數字"
                let pattern = new RegExp(patternParam);
                let msg = "";
                checkAccount = false;

                if($("#memberAccount").val()!=""){
                    if(!pattern.test($("#memberAccount").val())){
                        msg = "帳號只能輸入英文和數字";
                    }else {
                        $.ajax({
                            url: "isAccountExist", //連結到spring做資料庫的 memberAccount的搜尋
                            type: "post",
                            data: {
                                "loginLevel": "member",
                                "account": $("#memberAccount").val()
                            },
                            success: function (repeat) {
                                checkAccount = !eval(repeat);
                                msg = (checkAccount)?"<img src='correct.png'>":"帳號重複";
                                if(checkAccount){$("#memberAccount").removeClass("need2edit");}
                            }
                        }).always(function(){//接在ajax之後，因為ajax最後做，所以會先執行外面的$("#accountErrMsg").html(msg);
                        //所以當ajax做完後，東西沒辦法再丟出去顯示，所以要用.always去讓他不管如何都會做這件事
                        //下面的 IdNum也要改成這樣
                            $("#accountErrMsg").html(msg);
                        });
                    }
                }
                // $("#imageTest").attr("src", msg);
                $("#accountErrMsg").html(msg);
            });

            //會員姓名
            $("#memberName").blur(function () {
                // let patternParamE = '[a-zA-Z]';
                // let patternParamC = '[\u4e00-\u9fff]'; //中文的驗證
                let patternParam = '^[\u4e00-\u9fffa-zA-Z]+$'; //只能中、英文的驗證，不能"空白"、"數字"
                let pattern = new RegExp(patternParam);
                let msg = "";
                checkName = false;

                if ($("#memberName").val() != "") {
                    if (!pattern.test($("#memberName").val())) {
                        msg = "只能中文和英文";
                    } else {
                        //不為空白，且格式正確
                        checkName = true;
                        $("#memberName").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#nameErrMsg").html(msg);
            });

            //會員密碼
            //檢查長度與格式
            $("#memberPwd").blur(function () {
                let patternParam = '.*[a-zA-Z]+.*[0-9]+.*[!@#$%^&*]+.*' + '|'
                    + '.*[a-zA-Z]+.*[!@#$%^&*]+.*[0-9]+.*' + '|'
                    + '.*[0-9]+.*[a-zA-Z]+.*[!@#$%^&*]+.*' + '|'
                    + '.*[0-9]+.*[!@#$%^&*]+.*[a-zA-Z]+.*' + '|'
                    + '.*[!@#$%^&*]+.*[a-zA-Z]+.*[0-9]+.*' + '|'
                    + '.*[!@#$%^&*]+.*[0-9]+.*[a-zA-Z]+.*';
                let pattern = new RegExp(patternParam);
                let msg = "";
                checkPwd = false;

                if ($("#memberPwd").val() != "") {
                    if (!pattern.test($("#memberPwd").val()) || $("#memberPwd").val().length < 6) {
                        msg = "密碼格式不合";
                    } else {
                        checkPwd = true;
                        $("#memberPwd").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#pwdErrMsg").html(msg);
            });

            //確認密碼
            $("#memberPwdCheck").keyup(function () {
                let msg = "";
                checkPwdAgain = false;
                if ($("#memberPwdCheck").val() != "") {
                    if ($("#memberPwd").val() != $("#memberPwdCheck").val()) {
                        msg = "密碼不一致";
                    } else {
                        checkPwdAgain = true;
                        $("#memberPwdCheck").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#pwdCheckErrMsg").html(msg);
            }).blur(function(){
                let msg = "";
                checkPwdAgain = false;

                if($("#memberPwdCheck").val() == ""){
                    if($("#memberPwd").val() != ""){ msg = "請確認密碼"; }
                }else {
                    if($("#memberPwd").val() != $("#memberPwdCheck").val()){ msg = "密碼不一致"; }
                    else {
                        checkPwdAgain = true;
                        $("#memberPwdCheck").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#pwdCheckErrMsg").html(msg);
            });

            //會員生日
            //電腦打字時的格式 與 時間 的驗證
            $("#memberBirth").change(function () {
                let patternParam = '[0-9]{1,4}/[0-9]{1,2}/[0-9]{1,2}';
                let pattern = new RegExp(patternParam);

                let errMsg = "";
                checkBirth = false;

                if ($("#memberBirth").val() != "") {
                    if (pattern.test($("#memberBirth").val())) {
                        //檢查時間
                        let dateAnalysis = $("#memberBirth").val().split("/");
                        let year = parseInt(dateAnalysis[0]),
                            month = parseInt(dateAnalysis[1]),
                            day = parseInt(dateAnalysis[2]);

                        if (day >= 1) {
                            if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) {
                                if (day > 31) { errMsg = "日期錯誤"; }
                            } else if (month == 4 || month == 6 || month == 9 || month == 11) {
                                if (day > 30) { errMsg = "日期錯誤"; }
                            } else if (month == 2) {
                                if (((year % 4) == 0 && (year % 100) != 0) || (year % 400) == 0) {
                                    if (day > 29) { errMsg = "日期錯誤"; }
                                } else {
                                    if (day > 28) { errMsg = "日期錯誤"; }
                                }
                            } else { errMsg = "月份錯誤"; }
                        } else { errMsg = "日期錯誤"; }
                    } else { //pattern的格式檢查
                        errMsg = "格式不正確";
                    }
                    if (errMsg == "") { checkBirth = true; errMsg = "<img src='correct.png'>";$("#memberBirth").removeClass("need2edit");}
                }
                $("#birthErrMsg").html(errMsg);
            });

            //會員住址
            //只要註冊時 不為空就好??
            $("#memberAddress").blur(function () {
                let msg = "";
                checkAddress = false;
                if ($("#memberAddress").val() != "") {
                    checkAddress = true;
                    $("#memberAddress").removeClass("need2edit");
                    msg = "<img src='correct.png'>";
                }
                $("#addressErrMsg").html(msg);
            });

            //會員身高(cm)
            // 在<input>內設定長度為3
            $("#memberHeight").blur(function () {
                let height = $("#memberHeight").val();
                let msg = "";
                checkHeight = false;
                let check = true;

                if (height != "") {
                    for (i of height) {
                        if (i < '0' || i > '9') {
                            msg = "只能輸入整數數字";
                            check = false;
                            break;
                        }
                    }
                    if (check) {
                        let h = parseInt(height);
                        if (h <= 0 || h > 255) {
                            msg = "請輸入1~255之間的數值";
                        } else {
                            checkHeight = true;
                            $("#memberHeight").removeClass("need2edit");
                            msg = "<img src='correct.png'>";
                        }
                    }
                }
                $("#heightErrMsg").html(msg);
            });

            //會員體重(kg)
            //直接先用 "取整數做"
            // 在<input>內設定長度為3
            $("#memberWeight").blur(function () {
                let weight = $("#memberWeight").val();
                let msg = "";
                checkWeight = false;
                let check = true;

                if (weight != "") {
                    for (i of weight) {
                        if (i < '0' || i > '9') {
                            msg = "只能輸入整數數字";
                            check = false;
                            break;
                        }
                    }
                    if (check) {
                        let w = parseInt(weight);
                        if (w <= 0 || w > 255) {
                            msg = "請輸入1~255之間的數值";
                        } else {
                            checkWeight = true;
                            $("#memberWeight").removeClass("need2edit");
                            msg = "<img src='correct.png'>";
                        }
                    }
                }
                $("#weightErrMsg").html(msg);
            });

            //會員電話
            // 在<input>內設定長度為10
            $("#memberPhone").blur(function () {
                let patternParam = '[0]{1}[9]{1}[0-9]{8}';
                let pattern = new RegExp(patternParam);
                let msg = "";
                checkPhone = false;

                if ($("#memberPhone").val() != "") {
                    if (!pattern.test($("#memberPhone").val())) {
                        msg = "格式不正確";
                    } else {
                        checkPhone = true;
                        $("#memberPhone").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#phoneErrMsg").html(msg);

            });

            //身分證字號
            //在<input>內設定長度為10
            $("#memberIdNumber").blur(function () {
                let patternParam = '^[a-zA-Z]{1}[1-2]{1}[0-9]{8}';
                let pattern = new RegExp(patternParam);
                let msg = "";
                checkIdNum = false;

                if ($("#memberIdNumber").val() != "") {
                    if (!pattern.test($("#memberIdNumber").val())) {
                        msg = "格式錯誤";
                    } else {
                        $.ajax({
                            url:"isIdNumExist",
                            type:"post",
                            data:{ "IdNum":$("#memberIdNumber").val() },
                            success:function(repeat){
                                checkIdNum = !eval(repeat);
                                msg = (checkIdNum)?"<img src='correct.png'>":"資料重覆";
                                if(checkIdNum){$("#memberIdNumber").removeClass("need2edit");}
                            }
                        }).always(function(){
                            $("#IdNumErrMsg").html(msg);
                        });
                    }
                }
                $("#IdNumErrMsg").html(msg);
            });

            //性別
            //改成radio，讀值就好
            //test:
            // $("input[name=memberGender]").change(function () {
            //     gender = $("input[name=memberGender]:checked").val();
            //     // checkGender = true;
            // });

            //電子信箱 ==> 改用 input type="email"取讓他檢查就好??，但是送出時的 "不能空白"要再檢查???
            $("#email").blur(function () {
                let patternParam = '^[a-zA-Z0-9]+[\.]*[a-zA-Z0-9]+@[a-z]+\.[a-z\.]+';
                let pattern = new RegExp(patternParam);
                checkEmail = false;
                let msg = "";

                if ($("#email").val() != "") {
                    if (!pattern.test($("#email").val())) {
                        msg = "格式錯誤";
                    } else {
                        checkEmail = true;
                        $("#email").removeClass("need2edit");
                        msg = "<img src='correct.png'>";
                    }
                }
                $("#emailErrMsg").html(msg);
            });

        }

        //---------------------------------------------------------------------------------------------------
        //設定datepicker
        //這是初始化的設定，後面切換的放到切換裡面
        $("#memberBirth").datepicker({
            changeMonth: true,
            changeYear: true,
            yearRange: "1920:2020",
            dateFormat: "yy/mm/dd"
        });

    </script>
</body>

</html>